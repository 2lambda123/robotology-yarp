#!/bin/sh

# This script makes a debian package
# call from root as ./scripts/make-debian


# sudo apt-get install pbuilder debarchiver


# how to create pbuilder environments
#sudo pbuilder create --basetgz /var/cache/pbuilder/base-stable.tgz --distribution stable
#sudo pbuilder create --basetgz /var/cache/pbuilder/base-unstable.tgz --distribution unstable



ORG=$PWD
SRC=$PWD/source-package
BASE=$PWD/debian-package

echo "Make sure you run ./scripts/make-source-package first"

for f in `ls $SRC/*.tar.gz`; do
    echo Working with $f
    rm -rf $BASE
    mkdir -p $BASE
    cd $BASE
    tar xzvf - < $f
    dir=`basename $f .tar.gz`
    if [ -e $dir ]; then
	echo Working in $dir
	cd $dir
	YARP=$PWD
	echo Packaging...
	dists="stable unstable"
	if which pdebuild; then
	    for d in $dists; do
		cd $YARP
		mkdir -p ../$d
		pdebuild --buildresult ../$d -- --basetgz /var/cache/pbuilder/base-$d.tgz --distribution $d
		cd ../$d
		for c in `ls *.changes`; do
		    # distribution name is wrong at the moment
		    cp $c tmp.changes
		    cat tmp.changes | sed "s/unstable/$d/g" | tee $c
		    rm tmp.changes
		done
		mkdir -p $BASE/archive
		debarchiver -d $BASE/archive -i $PWD
	    done
	else
	    # just give a taste of packaging process
	    dpkg-buildpackage -us -uc -d -rfakeroot	
	fi
	echo "Results in $BASE/archive"
    fi
done



#cd $BASE
#pbuilder build $BASE/*.dsc


